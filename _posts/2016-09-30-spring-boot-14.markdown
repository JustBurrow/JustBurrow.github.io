---
layout: post
title: Spring Boot 1.4 적용하기
---

기존에 작성하던 프로젝트를 `Spring Boot 1.3.x`에서 `Spring Boot 1.4.1`로 업그레이드 하던 중, DB 커넥션을 맺지 못하는 현상이 생겼다.
해결을 위한 실험 과정을 기록한다.

## 목표

* 서브 모듈로 나눠 레이어별로 개발 및 테스트 환경 구축.
* Spring Boot의 자동 설정을 사용.
* Spring Data JPA / Hibernate / MySQL
* 어노테이션 기반 설정
* 내부 로직 공통 모듈화, 인터페이스 부분만 다른 웹 사이트와 JSON API 서버.

## All-In-One(v.1)

조건을 간단히 하기 위해, 하나의 모듈과 패키지에 인터페이스 없이 웹 애플리케이션을 만들었다.

최소한의 설정으로도 DB 커넥션을 생성할 수 있음을 확인.

커밋 트리에서는 일부 중간 단계를 생략했지만, 기본적인 설정으로도 DB 커넥션을 설정할 수 있다. 코드는 [springboot14v1](https://github.com/JustBurrow/pages/tree/springboot14/v1)에서 확인할 수 있다.

### Maven 설정

[parent 모듈 설정](https://github.com/JustBurrow/pages/blob/springboot14/v1/spring-boot14/pom.xml)으로 JDK의 버전 `1.8`과 Spring Boot의 버전 `1.4.1.RELEASE`를 생략. 사용한 라이브러리는 `spring-boot-dependencies` 모듈에서 지정한 버전을 사용한다.

```maven
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
  <modelVersion>4.0.0</modelVersion>
  <parent>
    <groupId>kr.lul.pages</groupId>
    <artifactId>spring-boot14</artifactId>
    <version>0.0.1-SNAPSHOT</version>
  </parent>
  <artifactId>spring-boot14-v1</artifactId>
  <dependencies>
    <dependency>
      <groupId>org.springframework.boot</groupId>
      <artifactId>spring-boot-starter-web</artifactId>
    </dependency>
    <dependency>
      <groupId>org.projectlombok</groupId>
      <artifactId>lombok</artifactId>
    </dependency>
    <dependency>
      <groupId>org.springframework.boot</groupId>
      <artifactId>spring-boot-starter-data-jpa</artifactId>
    </dependency>
    <dependency>
      <groupId>mysql</groupId>
      <artifactId>mysql-connector-java</artifactId>
    </dependency>
  </dependencies>
</project>
```

### 애플리케이션 설정

최소 설정으로도 DB 커넥션은 생성할 수 있는데, 예를 들어 `spring.datasource.driver-class-name`이 없어도 커넥션을 맺을 수 있다.

그런데 `spring.datasource.tomcat.validation-interval`은 작동이 이상해, 설정하더라도 5초 단위로 `spring.datasource.tomcat.validation-query`가 실행된다. 원인은 불명. 확인은 MySQL의 `general-query.log` 파일로 할 수 있다(`tail -f general-query.log`).

```yam
# src/main/resources/application.yml
spring:
  datasource:
    driver-class-name: 'com.mysql.jdbc.Driver'
    url: jdbc:mysql://localhost/springboot14v1
    username: test
    password: testuser
    tomcat:
      test-while-idle: true
      validation-query: 'SELECT 1'
  jpa:
    open-in-view: false
    generate-ddl: true
    show-sql: true
```
